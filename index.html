<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itin√©raire de la cour de Louis XVI repr√©sentatif de la saison th√©√¢trale de 1786</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Garamond', 'Georgia', serif;
            background-color: #f5f2eb;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #f5f2eb;
            padding: 20px 30px;
            text-align: center;
            border-bottom: 4px solid #c9a959;
        }

        .header h1 {
            font-size: 24px;
            font-weight: normal;
            letter-spacing: 2px;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .header h2 {
            font-size: 24px;
            font-weight: normal;
            font-style: italic;
            color: #c9a959;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 16px;
            color: #bdc3c7;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.5;
        }

        .map-container {
            flex: 1 1 auto;
            position: relative;
        }

        #map {
            height: 100%;
        }

        .legend {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font-size: 12px;
            line-height: 1.7;
            max-width: 320px;
        }

        .legend h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #2c3e50;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }

        .legend-subtitle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0 6px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid #e0e0e0;
        }

        .legend-subtitle .subtitle-text {
            font-weight: bold;
            font-size: 12px;
            color: #2c3e50;
        }

        .legend-subtitle .toggle-all {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #3498db;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .legend-subtitle .toggle-all:hover {
            background-color: #ebf5fb;
        }

        .legend-subtitle .toggle-all input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            width: 14px;
            height: 14px;
            flex-shrink: 0;
            accent-color: #33475c;
        }

        .legend-subtitle .toggle-all label {
            cursor: pointer;
            margin: 0;
            user-select: none;
        }

        .legend-group {
            margin-bottom: 5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .legend-item:hover {
            background-color: #f0f0f0;
        }
        /* Marqueur triangle pour les th√©√¢tres */
        .theatre-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.35));
        }
        .theatre-icon .marker-triangle {
            width: 0;
            height: 0;
            display: block;
        }

        .legend-item.inactive {
            opacity: 0.4;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }
        .legend-color.legend-color-triangle {
            width: 0;
            height: 0;
            border-top: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 14px solid #9b59b6; /* couleur surcharg√©e en inline */
            border-radius: 0;
            margin-right: 10px;
            margin-left: 2px;
            transform: translateY(-1px);
            line-height: 0;
            display: block;
        }

        .legend-text {
            flex-grow: 1;
        }

        .legend-count {
            font-size: 11px;
            color: #666;
            margin-left: 5px;
        }

        .footer {
            background: #2c3e50;
            color: #bdc3c7;
            padding: 15px 20px;
            font-size: 15px;
            text-align: center;
            line-height: 1.8;
        }

        .footer-source {
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.2em;
        }

        .footer a {
            color: #c9a959;
            text-decoration: none;
        }

        .footer .credits {

            font-style: italic;
            color: #95a5a6;
        }

        .leaflet-popup-content {
            font-family: 'Garamond', 'Georgia', serif;
            min-width: 220px;
        }

        .popup-title {
            font-size: 15px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
        }

        .popup-content {
            font-size: 14px;
            line-height: 1.6;
        }

        .popup-content strong {
            color: #34495e;
        }

        .popup-history {
            margin-top: 8px;
            padding: 8px;
            background-color: #f8f9fa;
            border-left: 3px solid #c9a959;
            font-style: italic;
            font-size: 14px;
        }

        .category-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 13px;
            margin-top: 5px;
        }

        .next-destination {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #ccc;
        }

        .next-destination a {
            color: #2980b9;
            text-decoration: none;
            cursor: pointer;
        }

        .next-destination a:hover {
            text-decoration: underline;
        }

        /* Barre de recherche */
        .search-control {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            min-width: 320px;
        }

        .search-control h4 {
            margin-bottom: 8px;
            font-size: 13px;
            color: #2c3e50;
        }

        .search-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Garamond', 'Georgia', serif;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            font-size: 13px;
        }

        .search-result-item {
            padding: 6px 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f0f7ff;
        }

        .search-result-item .result-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .search-result-item .result-date {
            color: #666;
            font-size: 12px;
        }

        .no-results {
            padding: 8px;
            color: #999;
            font-style: italic;
        }        

        /* Timeline temporelle */
        .timeline-toggle-container {
            display: flex;
        }
        
        .timeline-control {
            background: white;
            padding: 12px 14px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.25);
            font-size: 13px;
            min-width: 320px;
            max-width: 440px;
        }

        .timeline-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .timeline-play {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid #dcdcdc;
            background: #f7f7f7;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background-color 0.2s, transform 0.1s;
        }

        .timeline-play:hover {
            background: #eef5ff;
        }

        .timeline-play.playing {
            background: #c9e5ff;
            border-color: #7eb8ff;
        }

        .timeline-play:not(.playing) span {
            margin-top: -2px;
            margin-left: 2px;
        }

        .timeline-play.playing span {
            margin-top: -4px;
            margin-left: 0px;
        }

        .timeline-date {
            flex: 1;
            font-weight: bold;
            color: #2c3e50;
        }

        .timeline-slider {
            width: 100%;
            accent-color: #c9a959;
            cursor: pointer;
        }

        .timeline-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            color: #666;
            font-size: 11px;
        }

        .timeline-history {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #2c3e50;
        }

        .timeline-history input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #33475c;
        }

        .timeline-toggle {
            flex: 1 1 auto;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #2c3e50;
        }

        .timeline-toggle input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #33475c;
        }

        .timeline-speed {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 8px;
            font-size: 11px;
            color: #666;
        }

        .timeline-speed-label {
            margin-right: 4px;
        }

        .timeline-speed-btn {
            padding: 2px 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 3px;
            font-size: 11px;
            transition: all 0.2s;
        }

        .timeline-speed-btn:hover {
            background: #f0f0f0;
        }

        .timeline-speed-btn.active {
            background: #33475c;
            color: white;
            border-color: #33475c;
        }

        .timeline-speed-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>Itin√©raire de la cour de Louis XVI repr√©sentatif de la saison th√©√¢trale de 1786</h1>
        <h2>La saison th√©√¢trale</h2>
        <p>La saison th√©√¢trale s'ouvrait √† l'automne √† Fontainebleau, o√π les troupes parisiennes venaient faire le
            service de cour devant le roi. Elle se poursuivait √† Versailles en hiver jusqu'√† P√¢ques.</p>
    </div>

    <div class="map-container">
        <div id="map"></div>
    </div>

    <div class="footer">
        <div class="footer-source">
            <strong>Source des donn√©es :</strong> Caroline zum Kolk (√©d.), <em>Itin√©raire de Louis XVI. Les lieux de
                s√©jour du roi (1774-1789)</em>, Paris, <a href="https://cour-de-france.fr/squelettes/bases/itineraires/resultat_itineraire.php?Nr_personne=014&Town=0&year=1786" target="_blank">Cour de France.fr</a>, 2020.<br />
            Donn√©es publi√©es d'apr√®s l'itin√©raire constitu√© par Karima Mazingarbe dans le cadre d'un m√©moire de master.
            <div class="credits">Traitement des donn√©es et mise en forme par Elisa Broux</div>
        </div>
    </div>

    <script>
        // Initialisation de la carte centr√©e sur l'√éle-de-France
        const map = L.map('map', {
            zoomControl: false
        }).setView([48.75, 2.0], 9);
        
        // Ajouter le contr√¥le de zoom en bas √† droite
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        // Fond de carte sobre et acad√©mique
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
            maxZoom: 19
        }).addTo(map);

        // D√©finition des couleurs par cat√©gorie
        const colors = {
            theatres: '#9b59b6',        // Violet
            fontainebleau: '#e57373',   // Rouge clair
            versailles: '#64b5f6',      // Bleu clair
            chasse: '#81c784',          // Vert clair
            residences: '#fff176',      // Jaune clair
            normandie: '#d7ccc8'        // Beige
        };

        const categoryNames = {
            theatres: 'Principaux th√©√¢tres curiaux fr√©quent√©s en 1786',
            fontainebleau: 'Lieux fr√©quent√©s en saison d\'automne (Fontainebleau lieu de s√©jour principal)',
            versailles: 'Lieux fr√©quent√©s en saison d\'hiver (Versailles lieu de s√©jour principal)',
            chasse: 'Pavillons de chasse',
            residences: 'Autres r√©sidences royales',
            normandie: 'Voyage en Normandie (juin 1786)'
        };

        // Donn√©es des th√©√¢tres curiaux (pas de visitDates - toujours visibles)
        const theatres = [
            {
                id: 'theatre-aile-neuve', name: 'Th√©√¢tre de l\'Aile neuve', lat: 48.8048, lng: 2.1204, category: 'theatres',
                details: 'Construction du th√©√¢tre de l\'Aile neuve par Louis XVI et Marie-Antoinette au d√©but de l\'ann√©e 1786.',
                history: 'Ce th√©√¢tre fut √©difi√© pour remplacer l\'ancien Op√©ra royal jug√© trop grand et co√ªteux √† chauffer.'
            },
            {
                id: 'theatre-trianon', name: 'Th√©√¢tre de la Reine √† Trianon', lat: 48.8145, lng: 2.1052, category: 'theatres',
                details: 'Le th√©√¢tre de la Reine √† Trianon, lieu privil√©gi√© des repr√©sentations priv√©es de Marie-Antoinette.',
                history: 'Achev√© en 1780, ce petit th√©√¢tre de 250 places permettait √† la Reine de jouer elle-m√™me la com√©die.'
            },
            {
                id: 'theatre-fontainebleau', name: 'Th√©√¢tre de Fontainebleau', lat: 48.4020, lng: 2.7010, category: 'theatres',
                details: 'Le Th√©√¢tre de Fontainebleau, salle des spectacles de la cour durant la saison d\'automne.',
                history: 'La salle de spectacle du ch√¢teau de Fontainebleau accueillait chaque automne les repr√©sentations donn√©es par les troupes parisiennes.'
            }
        ];

        // Donn√©es des lieux avec visitDates (dates pr√©cises de chaque visite)
const places = [
    // FONTAINEBLEAU - Saison th√©√¢trale d'automne
    {
        id: 'fontainebleau', name: 'Fontainebleau', lat: 48.4049375, lng: 2.7015872, category: 'fontainebleau',
        visitDates: ['17861011','17861012','17861013','17861014','17861015','17861016','17861017','17861018','17861019','17861020','17861021','17861022','17861023','17861024','17861025','17861026','17861027','17861028','17861029','17861030','17861031','17861101','17861102','17861103','17861104','17861105','17861106','17861107','17861108','17861109','17861110','17861111','17861112','17861113','17861114','17861115'],
        details: 'R√©sidence principale de la saison d\'automne. Repr√©sentation d\'Az√©mire de M.-J. Ch√©nier le 4 novembre 1786.',
        history: 'Depuis Fran√ßois Ier, Fontainebleau accueillait la cour chaque automne pour la saison de chasse.'
    },
    {
        id: 'avon', name: 'Avon', lat: 48.4048867, lng: 2.7207225, category: 'fontainebleau',
        visitDates: ['17861026','17861104','17861108']
    },
    {
        id: 'chailly', name: 'Chailly-en-Bi√®re', lat: 48.4669449, lng: 2.608877, category: 'fontainebleau',
        visitDates: ['17861027','17861110']
    },
    {
        id: 'pringy', name: 'Pringy', lat: 48.521567, lng: 2.5587478, category: 'fontainebleau',
        visitDates: ['17861018']
    },
    {
        id: 'fontaine-le-port', name: 'Fontaine-le-Port', lat: 48.4867207, lng: 2.757027, category: 'fontainebleau',
        visitDates: ['17861021']
    },
    {
        id: 'lieusaint', name: 'Lieusaint', lat: 48.6316608, lng: 2.5514783, category: 'fontainebleau',
        visitDates: ['17861023']
    },
    {
        id: 'combs', name: 'Combs-la-Ville', lat: 48.6646994, lng: 2.564877, category: 'fontainebleau',
        visitDates: ['17861023']
    },
    {
        id: 'mandres', name: 'Mandres-les-Roses', lat: 48.7022193, lng: 2.5428063, category: 'fontainebleau',
        visitDates: ['17861030']
    },
    {
        id: 'villiers-orge', name: 'Villiers-sur-Orge', lat: 48.6585041, lng: 2.3010786, category: 'fontainebleau',
        visitDates: ['17861110']
    },
    {
        id: 'boissy', name: 'Boissy-Saint-L√©ger', lat: 48.7479193, lng: 2.5124717, category: 'fontainebleau',
        visitDates: ['17861122']
    },

    // VERSAILLES - Saison th√©√¢trale d'hiver
    {
        id: 'versailles', name: 'Versailles', lat: 48.8035403, lng: 2.1266886, category: 'versailles',
        visitDates: ['17860101','17860102','17860103','17860104','17860105','17860106','17860107','17860108','17860109','17860110','17860111','17860112','17860113','17860114','17860115','17860116','17860117','17860118','17860119','17860120','17860121','17860122','17860123','17860124','17860125','17860126','17860127','17860128','17860129','17860130','17860131','17860201','17860202','17860203','17860204','17860205','17860206','17860207','17860208','17860209','17860210','17860211','17860212','17860213','17860214','17860215','17860216','17860217','17860218','17860219','17860220','17860221','17860222','17860223','17860224','17860225','17860226','17860227','17860228','17860301','17860302','17860303','17860304','17860305','17860306','17860307','17860308','17860309','17860310','17860311','17860312','17860313','17860314','17860315','17860316','17860317','17860318','17860319','17860320','17860321','17860322','17860323','17860324','17860325','17860326','17860327','17860328','17860329','17860330','17860331','17860401','17860402','17860403','17860404','17860405','17860406','17860407','17860408','17860409','17860410','17860411','17860412','17860413','17860414','17860415','17860416','17860417','17860418','17860419','17860420','17860421','17860422','17860423','17860424','17860425','17860426','17860427','17860428','17860429','17860430','17860501','17860629','17860630','17860701','17860702','17860703','17860704','17860705','17860706','17860707','17860708','17860709','17860710','17860711','17860712','17860713','17860714','17860715','17860716','17860717','17860718','17860719','17860720','17860721','17860722','17860723','17860724','17860725','17860726','17860727','17860728','17860729','17860730','17860731','17860801','17860802','17860803','17860804','17860805','17860806','17860807','17860808','17860809','17860810','17860811','17860812','17860813','17860814','17860815','17860816','17860817','17860818','17860819','17860820','17860821','17860822','17860823','17860824','17860825','17860826','17860827','17860828','17860829','17860830','17860831','17860901','17860902','17860903','17860904','17860905','17860906','17860907','17860908','17860909','17860910','17860913','17860914','17860915','17860916','17860917','17860918','17860919','17860920','17860921','17860922','17860923','17860924','17860925','17860926','17860927','17860928','17860929','17860930','17861001','17861002','17861003','17861004','17861005','17861006','17861115','17861116','17861117','17861118','17861119','17861120','17861121','17861122','17861123','17861124','17861125','17861126','17861127','17861128','17861129','17861130','17861201','17861202','17861203','17861204','17861205','17861206','17861207','17861208','17861209','17861210','17861211','17861212','17861213','17861214','17861215','17861216','17861217','17861218','17861219','17861220','17861221','17861222','17861223','17861224','17861225','17861226','17861227','17861228','17861229','17861230','17861231'],
        details: 'R√©sidence principale de la saison d\'hiver (d√©cembre √† P√¢ques).',
        history: 'Versailles √©tait le c≈ìur du pouvoir royal. En 1786, Louis XVI y fit construire un nouveau th√©√¢tre dans l\'Aile neuve.'
    },
    {
        id: 'fresnes', name: 'Fresnes', lat: 48.7546687, lng: 2.3227967, category: 'versailles',
        visitDates: ['17861127']
    },
    {
        id: 'verrieres', name: 'Verri√®res-le-Buisson', lat: 48.7467819, lng: 2.2653844, category: 'versailles',
        visitDates: ['17860407','17861202']
    },
    {
        id: 'villejuif', name: 'Villejuif', lat: 48.7921098, lng: 2.3633048, category: 'versailles',
        visitDates: ['17861204']
    },
    {
        id: 'bievres', name: 'Bi√®vres', lat: 48.7547679, lng: 2.2170148, category: 'versailles',
        visitDates: ['17861211']
    },
    {
        id: 'villeneuve-roi', name: 'Villeneuve-le-Roi', lat: 48.7350308, lng: 2.4077003, category: 'versailles',
        visitDates: ['17861218']
    },

    // PAVILLONS DE CHASSE - Vert clair
    {
        id: 'glatigny', name: 'Glatigny', lat: 49.4961667, lng: 1.8952663, category: 'chasse',
        visitDates: ['17860102']
    },
    {
        id: 'trappes', name: 'Trappes', lat: 48.7760957, lng: 1.9988356, category: 'chasse',
        visitDates: ['17860104','17860502','17860826','17861125','17861229']
    },
    {
        id: 'st-germain', name: 'Saint-Germain-en-Laye', lat: 48.8990413, lng: 2.0942792, category: 'chasse',
        visitDates: ['17860109','17860113','17860117','17860123','17860126','17860130','17860206','17860220','17860227','17860306','17860313','17860320','17860327','17860410','17860417','17860424','17860501','17860708','17860715','17860722','17860729'],
        history: 'Ancienne r√©sidence royale, Saint-Germain-en-Laye conservait une importance pour la chasse dans ses for√™ts.'
    },
    {
        id: 'rocquencourt', name: 'Rocquencourt', lat: 48.833333, lng: 2.1063004, category: 'chasse',
        visitDates: ['17860124','17860222','17860310','17861227']
    },
    {
        id: 'la-celle', name: 'La Celle-Saint-Cloud', lat: 48.8478753, lng: 2.136145, category: 'chasse',
        visitDates: ['17860213','17860322','17860331','17860421','17861230']
    },
    {
        id: 'plaisir', name: 'Plaisir', lat: 48.817399, lng: 1.9476363, category: 'chasse',
        visitDates: ['17860424','17860506','17860701','17860717','17860909']
    },
    {
        id: 'st-remy', name: 'Saint-R√©my-l√®s-Chevreuse', lat: 48.7054888, lng: 2.071109, category: 'chasse',
        visitDates: ['17860428','17860712','17861006']
    },
    {
        id: 'guyancourt', name: 'Guyancourt', lat: 48.7709414, lng: 2.0706084, category: 'chasse',
        visitDates: ['17860502']
    },
    {
        id: 'rambouillet', name: 'Rambouillet', lat: 48.6452851, lng: 1.819207, category: 'chasse',
        visitDates: ['17860502','17860503','17860504','17860505','17860506','17860507','17860508','17860509','17860510','17860511','17860512','17860513','17860514','17860515','17860516','17860517','17860518','17860519','17860520','17860521','17860522','17860523','17860524','17860525','17860526','17860527','17860528','17860529','17860530','17860531','17860601','17860602','17860603','17860604','17860605','17860606','17860607','17860608','17860609','17860610','17860611','17860612','17860613','17860614','17860615','17860616','17860617','17860618','17860619','17860620','17861002'],
        details: 'R√©sidence de chasse acquise par Louis XVI en 1783.',
        history: 'Louis XVI acquit le domaine de Rambouillet en 1783 pour ses for√™ts giboyeuses.'
    },
    {
        id: 'perray', name: 'Le Perray-en-Yvelines', lat: 48.6924665, lng: 1.8538535, category: 'chasse',
        visitDates: ['17860518','17860526','17860531','17860602','17860606','17860609','17860613','17860616','17860620'],
        details: 'Pavillon de chasse de Saint-Hubert.',
        history: 'Le pavillon de Saint-Hubert, construit sous Louis XV, √©tait l\'un des rendez-vous de chasse favoris.'
    },
    {
        id: 'dourdan', name: 'Dourdan', lat: 48.5288442, lng: 2.0153689, category: 'chasse',
        visitDates: ['17860522']
    },
    {
        id: 'gazeran', name: 'Gazeran', lat: 48.6348196, lng: 1.771981, category: 'chasse',
        visitDates: ['17860828']
    },
    {
        id: 'orsay', name: 'Orsay', lat: 48.699184, lng: 2.187457, category: 'chasse',
        visitDates: ['17860829']
    },
    {
        id: 'ste-mesme', name: 'Sainte-Mesme', lat: 48.531728, lng: 1.9606419, category: 'chasse',
        visitDates: ['17860901','17860905']
    },
    {
        id: 'st-nom', name: 'Saint-Nom-la-Bret√®che', lat: 48.8641009, lng: 2.0205241, category: 'chasse',
        visitDates: ['17860902']
    },
    {
        id: 'villepreux', name: 'Villepreux', lat: 48.8323013, lng: 2.007049, category: 'chasse',
        visitDates: ['17860907']
    },
    {
        id: 'arcueil', name: 'Arcueil', lat: 48.8064996, lng: 2.3366502, category: 'chasse',
        visitDates: ['17860915']
    },
    {
        id: 'saclay', name: 'Saclay', lat: 48.7305162, lng: 2.172576, category: 'chasse',
        visitDates: ['17860918']
    },
    {
        id: 'poigny', name: 'Poigny-la-For√™t', lat: 48.6758342, lng: 1.752986, category: 'chasse',
        visitDates: ['17860919','17860927','17861002']
    },
    {
        id: 'rungis', name: 'Rungis', lat: 48.7484048, lng: 2.3472665, category: 'chasse',
        visitDates: ['17860920']
    },
    {
        id: 'chevilly', name: 'Chevilly-Larue', lat: 48.7714153, lng: 2.3469255, category: 'chasse',
        visitDates: ['17860922','17861127']
    },
    {
        id: 'thiais', name: 'Thiais', lat: 48.7643664, lng: 2.391024, category: 'chasse',
        visitDates: ['17860930']
    },
    {
        id: 'creteil', name: 'Cr√©teil', lat: 48.7771486, lng: 2.4530731, category: 'chasse',
        visitDates: ['17861003','17861221']
    },
    {
        id: 'davron', name: 'Davron', lat: 48.8651611, lng: 1.9466425, category: 'chasse',
        visitDates: ['17861005']
    },
    {
        id: 'boissiere', name: 'La Boissi√®re-√âcole', lat: 48.6818831, lng: 1.6415102, category: 'chasse',
        visitDates: ['17861017']
    },
    {
        id: 'gournay', name: 'Gournay-sur-Marne', lat: 48.8598434, lng: 2.576913, category: 'chasse',
        visitDates: ['17860819']
    },
    {
        id: 'montrouge', name: 'Montrouge', lat: 48.8188544, lng: 2.3194375, category: 'chasse',
        visitDates: ['17860822']
    },
    {
        id: 'poissy', name: 'Poissy', lat: 48.9274192, lng: 2.0426301, category: 'chasse',
        visitDates: ['17860811']
    },
    {
        id: 'jouy-josas', name: 'Jouy-en-Josas', lat: 48.76464, lng: 2.1684529, category: 'chasse',
        visitDates: ['17860805']
    },
    {
        id: 'chambourcy', name: 'Chambourcy', lat: 48.9058999, lng: 2.0396454, category: 'chasse',
        visitDates: ['17860128','17860807','17860817']
    },

    // AUTRES R√âSIDENCES ROYALES - Jaune clair
    {
        id: 'meudon', name: 'Meudon', lat: 48.8126688, lng: 2.2385432, category: 'residences',
        visitDates: ['17860120'],
        history: 'Ancienne r√©sidence du Grand Dauphin, fils de Louis XIV, Meudon servait de lieu de promenade et de chasse.'
    },
    {
        id: 'st-cloud', name: 'Saint-Cloud', lat: 48.8437412, lng: 2.219344, category: 'residences',
        visitDates: ['17860403'],
        details: 'R√©sidence acquise par Marie-Antoinette en 1785.',
        history: 'Marie-Antoinette acheta le ch√¢teau de Saint-Cloud en 1785 pour disposer d\'une r√©sidence personnelle proche de Paris.'
    },
    {
        id: 'jouy-moutier', name: 'Jouy-le-Moutier', lat: 49.0116, lng: 2.03194, category: 'residences',
        visitDates: ['17860406','17860504','17860703']
    },
    {
        id: 'magny', name: 'Magny-les-Hameaux', lat: 48.724051, lng: 2.0839562, category: 'residences',
        visitDates: ['17860415']
    },
    {
        id: 'paris', name: 'Paris', lat: 48.8588897, lng: 2.320041, category: 'residences',
        visitDates: ['17860427','17860928'],
        details: 'Visites officielles du roi √† Paris.',
        history: 'Louis XVI se rendait rarement √† Paris, pr√©f√©rant Versailles.'
    },
    {
        id: 'compiegne', name: 'Compi√®gne', lat: 49.4179497, lng: 2.8263171, category: 'residences',
        visitDates: ['17860911','17860912','17860913'],
        history: 'Compi√®gne √©tait traditionnellement la r√©sidence d\'√©t√© de la cour.'
    },
    {
        id: 'st-denis', name: 'Saint-Denis', lat: 48.9383732, lng: 2.3627508, category: 'residences',
        visitDates: ['17860910'],
        history: 'La basilique Saint-Denis abritait les tombeaux des rois de France.'
    },
    {
        id: 'choisy', name: 'Choisy-le-Roi', lat: 48.7630238, lng: 2.4093664, category: 'residences',
        visitDates: ['17861006','17861007','17861008','17861009','17861010','17861218','17861221']
    },
    {
        id: 'soisy', name: 'Soisy-sur-Seine', lat: 48.6502928, lng: 2.4490991, category: 'residences',
        visitDates: ['17861006','17861130','17861207']
    },
    {
        id: 'brunoy', name: 'Brunoy', lat: 48.6979312, lng: 2.5044613, category: 'residences',
        visitDates: ['17861008','17861030','17861130','17861207']
    },
    {
        id: 'villeneuve-st-georges', name: 'Villeneuve-Saint-Georges', lat: 48.7305272, lng: 2.44782, category: 'residences',
        visitDates: ['17861007','17861008']
    },
    {
        id: 'hay', name: "L'Ha√ø-les-Roses", lat: 48.7790514, lng: 2.3373021, category: 'residences',
        visitDates: ['17861009','17861204']
    },

    // VOYAGE EN NORMANDIE - Beige (juin 1786)
    {
        id: 'chandai', name: 'Chandai', lat: 48.7534847, lng: 0.740002, category: 'normandie',
        visitDates: ['17860621'],
        details: '√âtape du voyage vers Cherbourg.'
    },
    {
        id: 'harcourt', name: 'Harcourt', lat: 49.1668691, lng: 0.7857071, category: 'normandie',
        visitDates: ['17860621','17860622']
    },
    {
        id: 'cherbourg', name: 'Cherbourg-en-Cotentin', lat: 49.6425343, lng: -1.6249565, category: 'normandie',
        visitDates: ['17860622','17860623','17860624','17860625','17860626'],
        details: 'Visite des travaux de la digue et du port militaire. Point culminant du voyage.',
        history: 'Le voyage de Louis XVI √† Cherbourg en juin 1786 fut l\'un des rares d√©placements du roi en province.'
    },
    {
        id: 'montmartin', name: 'Montmartin-en-Graignes', lat: 49.2751306, lng: -1.1458554, category: 'normandie',
        visitDates: ['17860626']
    },
    {
        id: 'caen', name: 'Caen', lat: 49.1813403, lng: -0.3635615, category: 'normandie',
        visitDates: ['17860626','17860627'],
        history: 'Caen accueillit Louis XVI avec enthousiasme lors de son passage.'
    },
    {
        id: 'honfleur', name: 'Honfleur', lat: 49.4197222, lng: 0.2338889, category: 'normandie',
        visitDates: ['17860627']
    },
    {
        id: 'le-havre', name: 'Le Havre', lat: 49.4938975, lng: 0.1079732, category: 'normandie',
        visitDates: ['17860627','17860628'],
        history: 'Port majeur du commerce atlantique, Le Havre √©tait essentiel pour le commerce colonial fran√ßais.'
    },
    {
        id: 'rouen', name: 'Rouen', lat: 49.4404591, lng: 1.0939658, category: 'normandie',
        visitDates: ['17860628'],
        history: 'Capitale de la Normandie, Rouen √©tait la deuxi√®me ville du royaume par sa population.'
    },
    {
        id: 'gaillon', name: 'Gaillon', lat: 49.1605604, lng: 1.3336126, category: 'normandie',
        visitDates: ['17860628','17860629'],
        details: 'Derni√®re √©tape avant le retour √† Versailles.'
    }
];

        // Fusion des th√©√¢tres et des lieux
        const allPlaces = [...theatres, ...places];

        // --- Timeline : parsing des dates et plage temporelle ---
        const monthMap = {
            'janvier': 0, 'f√©vrier': 1, 'mars': 2, 'avril': 3, 'mai': 4, 'juin': 5,
            'juillet': 6, 'ao√ªt': 7, 'septembre': 8, 'octobre': 9, 'novembre': 10, 'd√©cembre': 11
        };

        // Parse une date au format YYYYMMDD (ex: 17860101)
        function parseSingleDate(dateStr) {
            if (!dateStr) return new Date(1786, 0, 1).getTime();
            const dateInt = parseInt(dateStr, 10);
            const year = Math.floor(dateInt / 10000);
            const month = Math.floor((dateInt % 10000) / 100) - 1; // 0-indexed
            const day = dateInt % 100;
            return new Date(year, month, day).getTime();
        }

        function formatTimelineDate(ts) {
            const date = new Date(ts);
            const month = Object.keys(monthMap).find(key => monthMap[key] === date.getMonth()) || '';
            return `${date.getDate()} ${month} 1786`.trim();
        }

        // Formater une date YYYYMMDD en DD/MM
        function formatDateShort(dateStr) {
            const dateInt = parseInt(dateStr, 10);
            const month = Math.floor((dateInt % 10000) / 100);
            const day = dateInt % 100;
            return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}`;
        }

        // Calculer le nombre de visites r√©elles (s√©quences de dates cons√©cutives)
        function countRealVisits(visitDates) {
            if (!visitDates || visitDates.length === 0) return 0;
            
            // Convertir en nombres et trier
            const sortedDates = visitDates.map(d => parseInt(d, 10)).sort((a, b) => a - b);
            
            let visitCount = 1;
            for (let i = 1; i < sortedDates.length; i++) {
                const prevDate = sortedDates[i - 1];
                const currDate = sortedDates[i];
                
                // Calculer la diff√©rence en jours
                const prevTimestamp = parseSingleDate(prevDate.toString());
                const currTimestamp = parseSingleDate(currDate.toString());
                const daysDiff = Math.round((currTimestamp - prevTimestamp) / (1000 * 60 * 60 * 24));
                
                // Si plus d'un jour d'√©cart, c'est une nouvelle visite
                if (daysDiff > 1) {
                    visitCount++;
                }
            }
            
            return visitCount;
        }

        // Construire la timeline √† partir des visitDates
        const timelineDatesByPlace = {};
        const allVisitDates = new Set();
        
        allPlaces.forEach(place => {
            if (place.visitDates && Array.isArray(place.visitDates)) {
                const timestamps = place.visitDates.map(parseSingleDate);
                timelineDatesByPlace[place.id] = timestamps;
                timestamps.forEach(ts => allVisitDates.add(ts));
            } else {
                timelineDatesByPlace[place.id] = [];
            }
        });
        
        const timelineDates = Array.from(allVisitDates).sort((a, b) => a - b);

        let currentTimelineIndex = 0;
        let timelineSlider = null;
        let timelineDateLabel = null;
        let timelinePlayButton = null;
        let timelineInterval = null;
        let timelineHistoryInput = null;
        let showHistory = false;
        let timelineEnableInput = null;
        let timelineEnabled = false;
        let timelineSpeed = 1; // Vitesse de lecture: 1, 5 ou 10

        function updateTimelineUi(enabled) {
            const control = document.querySelector('.timeline-control');
            if (!control) return;
            control.classList.toggle('timeline-disabled', !enabled);
            if (timelineSlider) timelineSlider.disabled = !enabled;
            if (timelinePlayButton) timelinePlayButton.disabled = !enabled;
            if (timelineHistoryInput) timelineHistoryInput.disabled = !enabled;
            
            // D√©sactiver/activer les boutons de vitesse
            document.querySelectorAll('.timeline-speed-btn').forEach(btn => {
                btn.disabled = !enabled;
            });
        }

        function setPlayIcon(isPlaying) {
            if (!timelinePlayButton) return;
            timelinePlayButton.querySelector('span').textContent = isPlaying ? '‚è∏' : '‚ñ∂';
            timelinePlayButton.setAttribute('aria-label', isPlaying ? 'Pause' : 'Lecture');
        }

        // Cr√©ation des groupes de calques pour la l√©gende interactive
        const layerGroups = {
            theatres: L.layerGroup(),
            fontainebleau: L.layerGroup(),
            versailles: L.layerGroup(),
            chasse: L.layerGroup(),
            residences: L.layerGroup(),
            normandie: L.layerGroup()
        };

        // √âtat de visibilit√© par cat√©gorie (th√©√¢tres visibles par d√©faut, autres masqu√©s)
        const visibility = {
            theatres: true,
            fontainebleau: true,
            versailles: true,
            chasse: true,
            residences: true,
            normandie: true
        };

        // Stockage des marqueurs par ID
        const markersById = {};

        // Applique la double contrainte : visibilit√© par cat√©gorie + position dans la timeline
        function updateMarkersVisibility() {
            const selectedDate = timelineDates[currentTimelineIndex];
            if (selectedDate === undefined) return;

            allPlaces.forEach(place => {
                const marker = markersById[place.id];
                const markerDates = timelineDatesByPlace[place.id] || [];
                const group = layerGroups[place.category];
                const isTheatre = place.category === 'theatres';
                
                let shouldBeVisible = visibility[place.category];
                
                // Les th√©√¢tres sont toujours visibles
                if (!isTheatre && timelineEnabled) {
                    if (showHistory) {
                        // Mode historique : visible si au moins une visite <= date s√©lectionn√©e
                        shouldBeVisible = shouldBeVisible && markerDates.some(d => d <= selectedDate);
                    } else {
                        // Mode exact : visible si visite exactement √† cette date
                        shouldBeVisible = shouldBeVisible && markerDates.includes(selectedDate);
                    }
                }

                if (!marker || !group) return;

                if (shouldBeVisible) {
                    if (!group.hasLayer(marker)) {
                        group.addLayer(marker);
                    }
                    if (map.hasLayer(group) === false && visibility[place.category]) {
                        group.addTo(map);
                    }
                } else if (group.hasLayer(marker)) {
                    group.removeLayer(marker);
                }
            });
        }

        // Fonction pour naviguer vers un lieu (affiche m√™me si cat√©gorie masqu√©e)
        function goToPlace(placeId) {
            const marker = markersById[placeId];
            if (marker) {
                // Trouver la cat√©gorie du lieu
                const place = allPlaces.find(p => p.id === placeId);
                if (place) {
                    const layerGroup = layerGroups[place.category];
                    
                    // S'assurer que le groupe de couches est visible sur la carte
                    if (!map.hasLayer(layerGroup)) {
                        layerGroup.addTo(map);
                    }
                    
                    // S'assurer que le marqueur est dans le groupe
                    if (!layerGroup.hasLayer(marker)) {
                        marker.addTo(layerGroup);
                    }
                }

                // Centrer sur le marqueur
                map.setView(marker.getLatLng(), 12);

                // Fonction pour ouvrir la popup de mani√®re s√©curis√©e
                function openPopupSafely() {
                    if (!map.hasLayer(marker)) {
                        return false;
                    }
                    
                    try {
                        marker.openPopup();
                        return true;
                    } catch (e) {
                        console.warn('Erreur lors de l\'ouverture de la popup:', e);
                        return false;
                    }
                }

                // Attendre que la carte soit compl√®tement charg√©e avant d'ouvrir la popup
                // Utiliser 'moveend' et 'zoomend' pour s'assurer que toutes les animations sont termin√©es
                let popupOpened = false;
                
                function tryOpenPopup() {
                    if (!popupOpened && openPopupSafely()) {
                        popupOpened = true;
                    }
                }
                
                map.once('moveend', () => {
                    setTimeout(tryOpenPopup, 200);
                });
                
                map.once('zoomend', () => {
                    setTimeout(tryOpenPopup, 200);
                });
                
                // Fallback : essayer apr√®s un d√©lai plus long si les √©v√©nements ne se d√©clenchent pas
                setTimeout(() => {
                    if (!popupOpened) {
                        tryOpenPopup();
                    }
                }, 500);
            }
        }

        function setTimelineIndex(index, syncSlider = true) {
            if (!timelineDates.length) return;
            currentTimelineIndex = Math.min(Math.max(index, 0), timelineDates.length - 1);
            if (timelineDateLabel) {
                timelineDateLabel.textContent = formatTimelineDate(timelineDates[currentTimelineIndex]);
            }
            if (syncSlider && timelineSlider) {
                timelineSlider.value = currentTimelineIndex;
            }
            updateMarkersVisibility();
        }

        function startTimeline() {
            if (timelineInterval || !timelineDates.length) return;
            if (timelinePlayButton) timelinePlayButton.classList.add('playing');
            setPlayIcon(true);
            const baseDelay = 1200; // D√©lai de base en ms
            const delay = baseDelay / timelineSpeed; // Ajuster selon la vitesse
            timelineInterval = setInterval(() => {
                if (currentTimelineIndex >= timelineDates.length - 1) {
                    stopTimeline();
                    return;
                }
                setTimelineIndex(currentTimelineIndex + 1);
            }, delay);
        }

        function stopTimeline() {
            if (timelinePlayButton) timelinePlayButton.classList.remove('playing');
            setPlayIcon(false);
            if (timelineInterval) {
                clearInterval(timelineInterval);
                timelineInterval = null;
            }
        }

        function setTimelineSpeed(speed) {
            const wasPlaying = timelineInterval !== null;
            if (wasPlaying) {
                stopTimeline();
            }
            timelineSpeed = speed;
            
            // Mettre √† jour les boutons de vitesse
            document.querySelectorAll('.timeline-speed-btn').forEach(btn => {
                const btnSpeed = parseInt(btn.getAttribute('data-speed'));
                if (btnSpeed === speed) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            if (wasPlaying) {
                startTimeline();
            }
        }

        // Fonction pour cr√©er un marqueur
        function createMarker(place) {
            const color = colors[place.category];
            const isTheatre = place.category === 'theatres';
            
            // Calculer le nombre de visites r√©elles et formater les dates
            const realVisitCount = place.visitDates ? countRealVisits(place.visitDates) : 0;
            const totalDays = place.visitDates ? place.visitDates.length : 0;
            let formattedDates = 'Non dat√©';
            
            if (place.visitDates && place.visitDates.length > 0) {
                if (place.visitDates.length > 10) {
                    // Plus de 10 jours : afficher "entre le ... et le ..."
                    const firstDate = formatDateShort(place.visitDates[0]);
                    const lastDate = formatDateShort(place.visitDates[place.visitDates.length - 1]);
                    formattedDates = `entre le ${firstDate} et le ${lastDate}`;
                } else {
                    // 10 jours ou moins : lister toutes les dates
                    formattedDates = place.visitDates.map(d => formatDateShort(d)).join(', ');
                }
            }

            let marker;
            if (isTheatre) {
                const size = 22;
                const icon = L.divIcon({
                    className: 'theatre-icon',
                    html: `<div class="marker-triangle" style="border-left:${size / 2}px solid transparent; border-right:${size / 2}px solid transparent; border-bottom:${size}px solid ${color};"></div>`,
                    iconSize: [size, size],
                    iconAnchor: [size / 2, size / 2],
                    popupAnchor: [0, -size / 2]
                });
                marker = L.marker([place.lat, place.lng], { icon });
            } else {
                marker = L.circleMarker([place.lat, place.lng], {
                    radius: realVisitCount > 5 ? 10 : (realVisitCount > 2 ? 8 : 6),
                    fillColor: color,
                    color: '#333',
                    weight: 1.5,
                    opacity: 1,
                    fillOpacity: 0.85
                });
            }

            let popupContent = `
                <div class="popup-title">${place.name}</div>
                <div class="popup-content">
                    ${realVisitCount > 0 ? `<strong>Nombre de visites :</strong> ${realVisitCount}${totalDays > realVisitCount ? ` (${totalDays} jours)` : ''}<br/>` : ''}
                    ${realVisitCount > 0 ? `<strong>Dates :</strong> ${formattedDates}<br/>` : ''}
                    ${place.details ? `<em>${place.details}</em><br/>` : ''}
                    ${place.history ? `<div class="popup-history">${place.history}</div>` : ''}
                    <span class="category-tag" style="background-color: ${color}; color: ${isTheatre ? '#fff' : '#333'};">${categoryNames[place.category]}</span>
                </div>
            `;

            marker.bindPopup(popupContent);
            return marker;
        }

        // Ajout des marqueurs pour les th√©√¢tres
        theatres.forEach(place => {
            const marker = createMarker(place);
            marker.addTo(layerGroups.theatres);
            markersById[place.id] = marker;
        });

        // Ajout des marqueurs pour les autres lieux
        places.forEach(place => {
            const marker = createMarker(place);
            marker.addTo(layerGroups[place.category]);
            markersById[place.id] = marker;
        });

        // Ajout initial : uniquement les th√©√¢tres
        Object.values(layerGroups).forEach(group => group.addTo(map));

        // Cr√©ation de la barre de recherche
        const searchControl = L.control({ position: 'topleft' });

        searchControl.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'search-control');
            div.innerHTML = `
                <h4>üîç Rechercher</h4>
                <input type="text" class="search-input" placeholder="Lieu ou date...">
                <div class="search-results"></div>
            `;

            const input = div.querySelector('.search-input');
            const resultsDiv = div.querySelector('.search-results');

            function performSearch() {
                const query = input.value.toLowerCase().trim();
                resultsDiv.innerHTML = '';

                if (query.length < 2) {
                    return;
                }

                const results = allPlaces.filter(p => {
                    const nameMatch = p.name.toLowerCase().includes(query);
                    const detailsMatch = p.details && p.details.toLowerCase().includes(query);
                    const historyMatch = p.history && p.history.toLowerCase().includes(query);
                    
                    // Rechercher dans les dates de visite
                    let datesMatch = false;
                    if (p.visitDates && Array.isArray(p.visitDates)) {
                        // Convertir les dates YYYYMMDD en formats lisibles pour la recherche
                        const searchableDates = p.visitDates.map(dateInt => {
                            const dateStr = dateInt.toString();
                            const year = dateStr.substring(0, 4);
                            const month = dateStr.substring(4, 6);
                            const day = dateStr.substring(6, 8);
                            
                            // Cr√©er diff√©rents formats de recherche
                            const monthNames = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 
                                              'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
                            const monthName = monthNames[parseInt(month) - 1];
                            
                            return [
                                `${day}/${month}`,           // 01/01
                                `${day}/${month}/${year}`,   // 01/01/1786
                                `${day}.${month}`,           // 01.01
                                `${day}.${month}.${year}`,   // 01.01.1786
                                `${day} ${monthName}`,       // 01 janvier
                                monthName,                   // janvier
                                dateStr                      // 17860101
                            ].join(' ');
                        }).join(' ').toLowerCase();
                        
                        datesMatch = searchableDates.includes(query);
                    }
                    
                    return nameMatch || datesMatch || detailsMatch || historyMatch;
                });

                if (results.length === 0) {
                    resultsDiv.innerHTML = '<div class="no-results">Aucun r√©sultat</div>';
                    return;
                }

                results.slice(0, 10).forEach(place => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    
                    // Formater les dates pour l'affichage
                    let dateDisplay = 'Non dat√©';
                    if (place.visitDates && place.visitDates.length > 0) {
                        const realVisits = countRealVisits(place.visitDates);
                        const totalDays = place.visitDates.length;
                        if (totalDays > 10) {
                            const firstDate = formatDateShort(place.visitDates[0]);
                            const lastDate = formatDateShort(place.visitDates[totalDays - 1]);
                            dateDisplay = `${realVisits} visite${realVisits > 1 ? 's' : ''} (entre le ${firstDate} et le ${lastDate})`;
                        } else {
                            dateDisplay = `${realVisits} visite${realVisits > 1 ? 's' : ''} (${totalDays} jour${totalDays > 1 ? 's' : ''})`;
                        }
                    }
                    
                    item.innerHTML = `
                        <div class="result-name">${place.name}</div>
                        <div class="result-date">${dateDisplay}</div>
                    `;
                    item.addEventListener('click', function () {
                        goToPlace(place.id);
                        input.value = '';
                        resultsDiv.innerHTML = '';
                    });
                    resultsDiv.appendChild(item);
                });
            }

            input.addEventListener('input', performSearch);

            input.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    const query = input.value.toLowerCase().trim();
                    if (query.length >= 2) {
                        const results = allPlaces.filter(p => {
                            const nameMatch = p.name.toLowerCase().includes(query);
                            let datesMatch = false;
                            if (p.visitDates && Array.isArray(p.visitDates)) {
                                const datesStr = p.visitDates.join(' ').toLowerCase();
                                datesMatch = datesStr.includes(query);
                            }
                            return nameMatch || datesMatch;
                        });
                        if (results.length > 0) {
                            goToPlace(results[0].id);
                            input.value = '';
                            resultsDiv.innerHTML = '';
                        }
                    }
                }
            });

            // Emp√™cher la propagation des √©v√©nements
            L.DomEvent.disableClickPropagation(div);
            L.DomEvent.disableScrollPropagation(div);

            return div;
        };

        searchControl.addTo(map);

        // Cr√©ation de la l√©gende interactive
        const legend = L.control({ position: 'topright' });

        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'legend');

            // div.innerHTML = '<h4>L√©gende</h4>';

            // Comptage des lieux par cat√©gorie
            const counts = {
                theatres: theatres.length
            };
            places.forEach(p => {
                counts[p.category] = (counts[p.category] || 0) + 1;
            });

            const theatreCategories = [
                { key: 'theatres', name: 'Principaux th√©√¢tres curiaux' }
            ];

            const sejourCategories = [
                { key: 'fontainebleau', name: 'Lieux fr√©quent√©s en saison d\'automne (Fontainebleau lieu de s√©jour principal)' },
                { key: 'versailles', name: 'Lieux fr√©quent√©s en saison d\'hiver (Versailles lieu de s√©jour principal)' },
                { key: 'chasse', name: 'Pavillons de chasse' },
                { key: 'residences', name: 'Autres r√©sidences royales' },
                { key: 'normandie', name: 'Voyage en Normandie' }
            ];

            // Fonction pour cr√©er un item de l√©gende
            function createLegendItem(cat, container) {
                const item = L.DomUtil.create('div', 'legend-item', container);
                item.setAttribute('data-category', cat.key);

            const colorIcon = cat.key === 'theatres'
                ? `<span class="legend-color legend-color-triangle" style="border-bottom-color: ${colors[cat.key]};"></span>`
                : `<span class="legend-color" style="background-color: ${colors[cat.key]};"></span>`;

            item.innerHTML = `
            ${colorIcon}
            <span class="legend-text">${cat.name}</span>
            <span class="legend-count">(${counts[cat.key] || 0})</span>
        `;

                item.addEventListener('click', function (e) {
                    e.stopPropagation();
                    visibility[cat.key] = !visibility[cat.key];

                    if (visibility[cat.key]) {
                        map.addLayer(layerGroups[cat.key]);
                        item.classList.remove('inactive');
                    } else {
                        map.removeLayer(layerGroups[cat.key]);
                        item.classList.add('inactive');
                    }
                    updateToggleButtons();
                    updateMarkersVisibility();
                });

                return item;
            }

            // Sous-titre 1 : Saison th√©√¢trale
            const subtitle1 = L.DomUtil.create('div', 'legend-subtitle', div);
            subtitle1.innerHTML = '<span class="subtitle-text">La saison th√©√¢trale en 1786</span><span class="toggle-all" data-group="theatres"><input type="checkbox" id="toggle-theatres" checked></span>';

            // Container pour les th√©√¢tres (sous subtitle1)
            const theatreContainer = L.DomUtil.create('div', 'legend-group', div);
            theatreContainer.setAttribute('data-group', 'theatres');
            theatreCategories.forEach(cat => createLegendItem(cat, theatreContainer));

            // Sous-titre 2 : S√©jours de la cour
            const subtitle2 = L.DomUtil.create('div', 'legend-subtitle', div);
            subtitle2.innerHTML = '<span class="subtitle-text">Les s√©jours de la cour en 1786</span><span class="toggle-all" data-group="sejours"><input type="checkbox" id="toggle-sejours" checked></span>';

            // Container pour les s√©jours (sous subtitle2)
            const sejourContainer = L.DomUtil.create('div', 'legend-group', div);
            sejourContainer.setAttribute('data-group', 'sejours');
            sejourCategories.forEach(cat => createLegendItem(cat, sejourContainer));

            // Fonction pour mettre √† jour les boutons "Tout"
            function updateToggleButtons() {
                const theatreKeys = theatreCategories.map(c => c.key);
                const sejourKeys = sejourCategories.map(c => c.key);

                const allTheatresVisible = theatreKeys.every(k => visibility[k]);
                const allSejoursVisible = sejourKeys.every(k => visibility[k]);

                const theatresCheckbox = div.querySelector('[data-group="theatres"] input[type="checkbox"]');
                const sejoursCheckbox = div.querySelector('[data-group="sejours"] input[type="checkbox"]');

                if (theatresCheckbox) theatresCheckbox.checked = allTheatresVisible;
                if (sejoursCheckbox) sejoursCheckbox.checked = allSejoursVisible;
            }

            // Gestionnaire pour "Tout s√©lectionner/d√©s√©lectionner"
            div.querySelectorAll('.toggle-all').forEach(btn => {
                const checkbox = btn.querySelector('input[type="checkbox"]');
                const group = btn.getAttribute('data-group');

                // Gestionnaire pour le clic sur le label ou le span
                btn.addEventListener('click', function (e) {
                    // Ne pas d√©clencher si on clique directement sur la checkbox (elle g√®re son propre √©v√©nement)
                    if (e.target.type === 'checkbox') return;
                    e.stopPropagation();
                    checkbox.checked = !checkbox.checked;
                    handleToggleAll(group, checkbox.checked);
                });

                // Gestionnaire pour le changement de la checkbox
                if (checkbox) {
                    checkbox.addEventListener('change', function (e) {
                        e.stopPropagation();
                        handleToggleAll(group, this.checked);
                    });
                }
            });

            function handleToggleAll(group, newState) {
                const keys = group === 'theatres'
                    ? theatreCategories.map(c => c.key)
                    : sejourCategories.map(c => c.key);

                keys.forEach(key => {
                    visibility[key] = newState;
                    if (newState) {
                        map.addLayer(layerGroups[key]);
                    } else {
                        map.removeLayer(layerGroups[key]);
                    }
                    const item = div.querySelector(`[data-category="${key}"]`);
                    if (item) {
                        item.classList.toggle('inactive', !newState);
                    }
                });

                updateToggleButtons();
                updateMarkersVisibility();
            }

            const note = L.DomUtil.create('p', '', div);
            note.style.cssText = 'font-size: 11px; color: #888; margin-top: 10px; font-style: italic;';
            note.textContent = 'Cliquez sur une cat√©gorie pour l\'afficher/masquer';

            L.DomEvent.disableClickPropagation(div);
            L.DomEvent.disableScrollPropagation(div);

            return div;
        };

        legend.addTo(map);

        // Contr√¥le timeline
        const timelineControl = L.control({ position: 'bottomleft' });

        timelineControl.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'timeline-control leaflet-control');

            const minLabel = timelineDates.length ? formatTimelineDate(timelineDates[0]) : '';
            const maxLabel = timelineDates.length ? formatTimelineDate(timelineDates[timelineDates.length - 1]) : '';

            div.innerHTML = `
                <div class="timeline-toggle-container">
                    <label class="timeline-toggle">
                        <input type="checkbox" class="timeline-enable-input">
                        Activer la timeline
                    </label>
                    <label class="timeline-history">
                        <input type="checkbox" class="timeline-history-input">
                        Garder l'historique
                    </label>
                </div>
                <div class="timeline-header">
                    <button class="timeline-play" title="Lecture/Pause"><span>‚ñ∂</span></button>
                    <div class="timeline-date"></div>
                    <div class="timeline-speed">
                        <button class="timeline-speed-btn active" data-speed="1">x1</button>
                        <button class="timeline-speed-btn" data-speed="5">x5</button>
                        <button class="timeline-speed-btn" data-speed="10">x10</button>
                    </div>
                </div>
                <input type="range" class="timeline-slider" min="0" max="${Math.max(timelineDates.length - 1, 0)}" value="${currentTimelineIndex}">
                <div class="timeline-scale">
                    <span>${minLabel}</span>
                    <span>${maxLabel}</span>
                </div>
            `;

            timelineSlider = div.querySelector('.timeline-slider');
            timelineDateLabel = div.querySelector('.timeline-date');
            timelinePlayButton = div.querySelector('.timeline-play');
            timelineHistoryInput = div.querySelector('.timeline-history-input');
            timelineEnableInput = div.querySelector('.timeline-enable-input');

            // Appliquer l'√©tat initial d√©sactiv√©
            if (timelineEnableInput) {
                timelineEnableInput.checked = timelineEnabled;
            }
            updateTimelineUi(timelineEnabled);

            if (timelineDateLabel && timelineDates.length) {
                timelineDateLabel.textContent = formatTimelineDate(timelineDates[currentTimelineIndex]);
            }
            setPlayIcon(false);

            if (timelineSlider) {
                timelineSlider.addEventListener('input', (e) => {
                    stopTimeline();
                    setTimelineIndex(Number(e.target.value), false);
                });
            }

            if (timelinePlayButton) {
                timelinePlayButton.addEventListener('click', () => {
                    if (timelineInterval) {
                        stopTimeline();
                    } else {
                        // Repart de la date courante jusqu'√† la fin
                        if (currentTimelineIndex >= timelineDates.length - 1) {
                            setTimelineIndex(0);
                        }
                        startTimeline();
                    }
                });
            }

            if (timelineHistoryInput) {
                timelineHistoryInput.addEventListener('change', (e) => {
                    showHistory = e.target.checked;
                    updateMarkersVisibility();
                });
            }

            if (timelineEnableInput) {
                timelineEnableInput.addEventListener('change', (e) => {
                    timelineEnabled = e.target.checked;
                    if (!timelineEnabled) {
                        stopTimeline();
                    }
                    updateTimelineUi(timelineEnabled);
                    updateMarkersVisibility();
                });
            }

            // Gestionnaires pour les boutons de vitesse
            div.querySelectorAll('.timeline-speed-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const speed = parseInt(btn.getAttribute('data-speed'));
                    setTimelineSpeed(speed);
                });
            });

            L.DomEvent.disableClickPropagation(div);
            L.DomEvent.disableScrollPropagation(div);

            return div;
        };

        timelineControl.addTo(map);
        setTimelineIndex(currentTimelineIndex);
        if (!timelineEnabled) {
            updateMarkersVisibility();
        }
        updateTimelineUi(timelineEnabled);

        // Ajout d'une ligne pour le voyage en Normandie
        const normandieRoute = [
            [48.8035403, 2.1266886],  // Versailles (d√©part)
            [48.7534847, 0.740002],   // Chandai
            [49.1668691, 0.7857071],  // Harcourt
            [49.6425343, -1.6249565], // Cherbourg
            [49.2751306, -1.1458554], // Montmartin
            [49.1813403, -0.3635615], // Caen
            [49.4197222, 0.2338889],  // Honfleur
            [49.4938975, 0.1079732],  // Le Havre
            [49.4404591, 1.0939658],  // Rouen
            [49.1605604, 1.3336126],  // Gaillon
            [48.8035403, 2.1266886]   // Retour Versailles
        ];

        const routeLine = L.polyline(normandieRoute, {
            color: '#8d6e63',
            weight: 2,
            opacity: 0.6,
            dashArray: '5, 10'
        }).addTo(layerGroups.normandie);

        routeLine.bindPopup('<strong>Voyage en Normandie</strong><br/>21-29 juin 1786<br/>Visite de Louis XVI √† Cherbourg');
    </script>
</body>

</html>
